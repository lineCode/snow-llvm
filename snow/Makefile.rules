include Makefile.config

all: $(TARGETS)

ALL_OBJECTS := $(OBJECTS_snow_bc) $(OBJECTS_snow)  ## TODO: Make this autogenerated from TARGETS

BC_CC_COMMAND = $(BC_CC) -c -emit-llvm $(BC_CFLAGS)
BC_CXX_COMMAND = $(BC_CXX) -c -emit-llvm $(BC_CXXFLAGS)
CC_COMMAND = $(CC) -c $(CFLAGS)
CXX_COMMAND = $(CXX) -c $(CXXFLAGS)

BC_CC_MM_COMMAND = $(BC_CC) $(BC_CFLAGS) -MM
BC_CXX_MM_COMMAND = $(BC_CXX) $(BC_CXXFLAGS) -MM
CC_MM_COMMAND = $(CC) $(CFLAGS) -MM
CXX_MM_COMMAND = $(CXX) $(CXXFLAGS) -MM

%.c.bc: %.c .%.c.bc.deps Makefile.config
	$(BC_CC_COMMAND) -o $@ $<

%.cpp.bc: %.cpp .%.cpp.bc.deps Makefile.config
	$(BC_CXX_COMMAND) -o $@ $<

%.c.o: %.c .%.c.o.deps Makefile.config
	$(CC_COMMAND) -o $@ $<

%.cpp.o: %.cpp .%.cpp.o.deps Makefile.config
	$(CXX_COMMAND) -o $@ $<


%.c.bc.deps: %.c Makefile.config
	@($(BC_CC_MM_COMMAND) -MM $< | sed -e s/\\.o/.c.bc/g > $@)
%.cpp.bc.deps: %.cpp Makefile.config
	@($(BC_CXX_MM_COMMAND) -MM $< | sed -e s/\\.o/.cpp.bc/g > $@)
%.c.o.deps: %.c Makefile.config
	@($(CC_MM_COMMAND) -MM $< > $@)
%.cpp.o.deps: %.cpp Makefile.config
	@($(CXX_MM_COMMAND) -MM $< > $@)

.PHONY: clean depends all
.DEFAULT_GOAL := all
.DELETE_ON_ERROR :=

DEPENDENCIES := $(patsubst %,%.deps,$(ALL_OBJECTS))
depends: $(DEPENDENCIES)
	rm -f .depends
	cat $(DEPENDENCIES) > .depends
	rm *.deps

ifneq ($(MAKECMDGOALS),clean)
-include .depends
endif

clean:
	-rm -f $(ALL_OBJECTS) $(TARGETS)
